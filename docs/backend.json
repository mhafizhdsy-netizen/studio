{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the GenHPP application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user entity."
        },
        "name": {
          "type": "string",
          "description": "The user's display name."
        },
        "email": {
          "type": "string",
          "description": "The user's email address.",
          "format": "email"
        },
        "photoURL": {
          "type": "string",
          "description": "The URL of the user's profile picture.",
          "format": "uri"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the user account was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "name",
        "email",
        "photoURL",
        "createdAt"
      ]
    },
    "Calculation": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Calculation",
      "type": "object",
      "description": "Represents a single HPP calculation performed by a user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the calculation entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Calculation)"
        },
        "productName": {
          "type": "string",
          "description": "The name of the product for which HPP was calculated."
        },
        "productImageUrl": {
          "type": "string",
          "description": "The URL for the product's image.",
          "format": "uri"
        },
        "materials": {
          "type": "array",
          "description": "A list of material costs associated with the product.",
          "items": {
            "type": "string"
          }
        },
        "laborCost": {
          "type": "number",
          "description": "The labor cost associated with producing the product."
        },
        "overhead": {
          "type": "number",
          "description": "Overhead costs associated with producing the product."
        },
        "packaging": {
          "type": "number",
          "description": "Packaging costs associated with the product."
        },
        "totalHPP": {
          "type": "number",
          "description": "The total HPP calculated for the product."
        },
        "suggestedPrice": {
          "type": "number",
          "description": "The suggested selling price for the product."
        },
        "margin": {
          "type": "number",
          "description": "The profit margin percentage."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the calculation was performed.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "productName",
        "totalHPP",
        "suggestedPrice",
        "margin",
        "createdAt"
      ]
    },
    "PublicCalculation": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "PublicCalculation",
      "type": "object",
      "description": "Represents a calculation shared publicly by a user, excluding personal data.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the public calculation entity."
        },
        "calculationId": {
          "type": "string",
          "description": "Reference to the original Calculation."
        },
        "productName": {
          "type": "string",
          "description": "The name of the product."
        },
        "productImageUrl": {
          "type": "string",
          "description": "The URL for the product's image.",
          "format": "uri"
        },
        "totalHPP": {
          "type": "number",
          "description": "The total HPP calculated for the product."
        },
        "suggestedPrice": {
          "type": "number",
          "description": "The suggested selling price for the product."
        },
        "margin": {
          "type": "number",
          "description": "The profit margin percentage."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the calculation was performed.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "calculationId",
        "productName",
        "totalHPP",
        "suggestedPrice",
        "margin",
        "createdAt"
      ]
    },
    "Comment": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Comment",
      "type": "object",
      "description": "Represents a comment made by a user on a public calculation.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the comment."
        },
        "userId": {
          "type": "string",
          "description": "The UID of the user who made the comment."
        },
        "userName": {
          "type": "string",
          "description": "The display name of the user."
        },
        "userPhotoURL": {
          "type": "string",
          "description": "The photo URL of the user.",
          "format": "uri"
        },
        "text": {
          "type": "string",
          "description": "The content of the comment."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the comment was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "userName",
        "text",
        "createdAt"
      ]
    },
    "ChatSession": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ChatSession",
      "type": "object",
      "description": "Represents a random, anonymous chat session.",
      "properties": {
        "participantIds": {
          "type": "array",
          "items": { "type": "string" },
          "description": "An array of exactly two user UIDs who are part of this session."
        },
        "status": {
            "type": "string",
            "enum": ["pending", "active", "closed"],
            "description": "The current status of the chat session."
        },
        "createdAt": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp when the session was created."
        }
      },
      "required": ["participantIds", "status", "createdAt"]
    },
    "ChatMessage": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ChatMessage",
      "type": "object",
      "description": "Represents a single message within a chat session.",
      "properties": {
        "senderId": {
          "type": "string",
          "description": "The UID of the user who sent the message."
        },
        "type": {
          "type": "string",
          "enum": ["text", "image", "calculation", "system"],
          "description": "The type of message content."
        },
        "text": {
          "type": "string",
          "description": "The text content of the message."
        },
        "mediaUrl": {
          "type": "string",
          "format": "uri",
          "description": "The URL of the uploaded image (if type is 'image')."
        },
        "mediaName": {
          "type": "string",
          "description": "The name of the uploaded file."
        },
        "calculationId": {
          "type": "string",
          "description": "The ID of the shared calculation (if type is 'calculation')."
        },
        "createdAt": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp when the message was sent."
        }
      },
      "required": ["senderId", "type", "createdAt"]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profiles. The 'userId' parameter corresponds to the Firebase Auth UID.  Authorization is based on path ownership: only the authenticated user can access their own profile.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Auth UID of the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/calculations/{calcId}",
        "definition": {
          "entityName": "Calculation",
          "schema": {
            "$ref": "#/backend/entities/Calculation"
          },
          "description": "Stores calculation history for each user. The 'userId' parameter corresponds to the Firebase Auth UID. Authorization is based on path ownership: only the authenticated user can access their own calculations.  Includes the 'userId' field to enforce ownership invariants.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Auth UID of the user."
            },
            {
              "name": "calcId",
              "description": "The unique ID of the calculation."
            }
          ]
        }
      },
      {
        "path": "/public_calculations/{calcId}",
        "definition": {
          "entityName": "PublicCalculation",
          "schema": {
            "$ref": "#/backend/entities/PublicCalculation"
          },
          "description": "Stores publicly shared calculation data. No user-identifiable information is stored here to maintain privacy. Anyone can read these calculations, but only the original user (verified via a server-side function or callable) can create/delete/modify them.",
          "params": [
            {
              "name": "calcId",
              "description": "The unique ID of the public calculation."
            }
          ]
        }
      },
       {
        "path": "/public_calculations/{calcId}/comments/{commentId}",
        "definition": {
          "entityName": "Comment",
          "schema": {
            "$ref": "#/backend/entities/Comment"
          },
          "description": "Stores comments for a public calculation. Anyone can read, but only authenticated users can write. The 'calcId' parameter corresponds to the ID of the public calculation.",
          "params": [
            {
              "name": "calcId",
              "description": "The unique ID of the public calculation."
            },
            {
              "name": "commentId",
              "description": "The unique ID of the comment."
            }
          ]
        }
      },
      {
        "path": "/chat_sessions/{sessionId}",
        "definition": {
          "entityName": "ChatSession",
          "schema": { "$ref": "#/backend/entities/ChatSession" },
          "description": "Stores metadata for an anonymous chat session. Only participants can read or update this document.",
          "params": [{ "name": "sessionId", "description": "The unique ID of the chat session." }]
        }
      },
      {
        "path": "/chat_sessions/{sessionId}/messages/{messageId}",
        "definition": {
          "entityName": "ChatMessage",
          "schema": { "$ref": "#/backend/entities/ChatMessage" },
          "description": "Stores the messages for a specific chat session. Only participants of the parent session can read or write messages here.",
          "params": [
            { "name": "sessionId", "description": "The unique ID of the chat session." },
            { "name": "messageId", "description": "The unique ID of the message." }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed for a random anonymous chat feature. The `chat_sessions` collection manages the lifecycle of a chat, matching users and tracking status. Each session has a `messages` sub-collection for the actual conversation. This ensures that chat data is isolated and only accessible to the paired participants, as enforced by security rules. Other data structures for users, calculations, and comments remain unchanged."
  }
}
